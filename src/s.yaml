edition: 3.0.0
name: AgentCraft-CAP
access: '{{ access }}'
vars:
  region: '{{ region }}'
  beFunctionName: '{{ beFunctionName }}'
  feFunctionName: '{{ feFunctionName }}'
  fcRole: "{{ fcRole }}"
  JWT_SECRET: "{{ JWT_SECRET }}"
  dashscopeApiKey: "{{ dashscopeApiKey }}"
template:
  AgentCraftAll:
    internetAccess: true
    # logConfig: auto
    vpcConfig: auto
resources:
  agentcraft-backend:
    component: fc3
    props:
      region: ${vars.region}
      handler: index.handler
      description: AgentCraft后端API服务
      timeout: 7200
      layers:
        - acs:fc:${vars.region}:1154600634854327:layers/agentcraft-backend-functionai-release/versions/1
        - acs:fc:${vars.region}:official:layers/Nodejs-Puppeteer19x/versions/1
        - acs:fc:${vars.region}:official:layers/Nodejs20/versions/3
      customRuntimeConfig:
        command:
          - python3
          - '-u'
          - app/main.py
        port: 8000
      runtime: custom.debian10
      instanceConcurrency: 100
      role: ${vars.fcRole}
      cpu: 2
      memorySize: 3072
      diskSize: 512
      environmentVariables:
        PATH: >-
          /var/fc/lang/python3.10/bin::/usr/local/bin/apache-maven/bin:/usr/local/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/local/ruby/bin:/opt/bin:/code:/code/bin:/var/fc/lang/python3.12/bin:/var/fc/lang/nodejs20/bin:/usr/local/bin/apache-maven/bin:/usr/local/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/local/ruby/bin:/opt/bin:/code:/code/bin:/opt/nodejs20/bin
        PYTHONPATH: /opt/python:/code
        EMBEDDING_TIMEOUT: '600'
        DASHSCOPE_API_KEY: ${vars.dashscopeApiKey}
        WORKERS: '4'
        POSTGRES_HOST: ''
        POSTGRES_DATABASE: ''
        POSTGRES_USER: ''
        POSTGRES_PASSWORD: ''
        EMBEDDING_TOKEN: ''
        CREATE_TABLES: '1'
        EMBEDDING_URL: ''
        EMBEDDING_MODEL: 'text-embedding-v4'
        EMBEDDING_DIM: ''
        JWT_SECRET: ${vars.JWT_SECRET}
        REGION: ${vars.region}
        MAIN_ACCOUNT_ID: ${config("AccountID")}
      functionName: ${vars.beFunctionName}
      code: ./agentcraft-all/agentcraft-be
      triggers:
        - description: ''
          triggerName: httpTrigger
          triggerType: http
          triggerConfig:
            methods:
              - GET
              - POST
              - PUT
              - DELETE
              - HEAD
              - OPTIONS
            authType: anonymous
            disableURLInternet: false
      customDomain:
        protocol: "HTTP"
        route:
          path: "/*"
          qualifier: "LATEST"
        domainName: auto
    extend:
      name: AgentCraftAll
  agentcraft-frontend:
    component: fc3
    # actions:
    #   pre-deploy:
    #     - run: npm i --production -f
    #       path: ./agentcraft-all/agentcraft-fe
    props:
      region: ${vars.region}
      description: AgentCraft前端服务
      timeout: 600
      diskSize: 512
      customRuntimeConfig:
        port: 3000
        command:
          - bootstrap
      layers:
        - acs:fc:${vars.region}:official:layers/Nodejs18/versions/1
        - acs:fc:${vars.region}:1154600634854327:layers/agentcraft-frontend-functionai-node-canvas-lib-release/versions/1
        - acs:fc:${vars.region}:1154600634854327:layers/agentcraft-frontend-functionai-node-canvas-release/versions/1
        - >-
          acs:fc:${vars.region}:1154600634854327:layers/agentcraft-frontend-functionai-release/versions/2
      runtime: custom.debian10
      instanceConcurrency: 100
      memorySize: 3072
      role: ${vars.fcRole}
      cpu: 2
      environmentVariables:
        LD_LIBRARY_PATH: /code:/code/lib:/usr/local/lib:/opt/lib
        baseUrl: ${resources.agentcraft-backend.output.url.system_intranet_url} # 仅在fc环境使用内网地址
        openApiUrl: ${resources.agentcraft-backend.output.url.system_url}
        beFunctionName: ${vars.beFunctionName}
        NODE_PATH: /opt/nodejs/node_modules
        Region: ${vars.region}
        MAIN_ACCOUNT_ID: ${config("AccountID")}
        DASHSCOPE_API_KEY: ${vars.dashscopeApiKey}
        JWT_SECRET: ${vars.JWT_SECRET}
        PATH: >-
          /opt/nodejs18/bin::/usr/local/bin/apache-maven/bin:/usr/local/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/local/ruby/bin:/opt/bin:/code:/code/bin:/opt/nodejs/node_modules/.bin
      functionName: ${vars.feFunctionName}
      code: ./agentcraft-all/agentcraft-fe
      triggers:
        - description: ''
          qualifier: LATEST
          triggerName: defaultTrigger
          triggerType: http
          triggerConfig:
            methods:
              - GET
              - POST
              - PUT
              - DELETE
            authType: anonymous
            disableURLInternet: false
      customDomain:
        protocol: "HTTP"
        route:
          path: "/*"
          qualifier: "LATEST"
        domainName: auto
    extend:
      name: AgentCraftAll
  